/**
 * Este conjunto de reglas impone un modelo estricto de propiedad del usuario para la aplicación CV Spark AI.
 * Todo el contenido generado por el usuario, incluidos los perfiles y los CV, está protegido para garantizar
 * que solo el propietario autenticado de los datos pueda acceder a ellos o modificarlos.
 *
 * Filosofía Principal:
 * El modelo de seguridad se basa en el principio de privilegio mínimo. Por defecto, todo
 * el acceso está denegado. Las reglas otorgan explícitamente permisos solo al propietario
 * autenticado de un recurso de datos específico.
 *
 * Estructura de Datos:
 * Los datos se organizan jerárquicamente para simplificar la seguridad. Los datos de cada usuario se
 * almacenan en una ruta única:
 * - /users/{userId}: Almacena el perfil público del usuario.
 * - /users/{userId}/cvs/{cvId}: Una subcolección que contiene todos los CV creados por ese usuario.
 * Esta propiedad basada en la ruta hace que las reglas sean simples, eficientes y fáciles de auditar.
 *
 * Decisiones Clave de Seguridad:
 * - Listado de Usuarios Deshabilitado: No es posible listar todos los usuarios en la colección `/users`.
 *   Esta es una característica de privacidad crítica para evitar el raspado de datos de usuarios.
 * - Propiedad Estricta: Todas las operaciones (lectura, escritura, eliminación) en el árbol de datos de un usuario
 *   (su perfil y sus CV) están restringidas al usuario cuyo UID coincide con el
 *   `{userId}` en la ruta.
 * - Integridad Relacional: En la creación de documentos, las reglas validan que el campo de ID del propietario
 *   dentro de los datos del documento (p. ej., `User.uid`, `Cv.userId`) coincida con el
 *   `{userId}` de la ruta. Este campo se aplica como inmutable en las actualizaciones para
 *   evitar que los documentos sean "reasignados" a otro usuario.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Funciones de ayuda para promover reglas legibles, reutilizables y mantenibles.

    /**
     * Comprueba si la solicitud actual proviene de un usuario autenticado.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Comprueba si el UID del usuario actualmente conectado coincide con el userId proporcionado.
     * Esta es la función principal para establecer la propiedad del documento.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Comprueba la propiedad en un documento existente. Se utiliza para operaciones de actualización y eliminación
     * para evitar actuar sobre documentos que no existen.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description   Asegura el documento de perfil de un usuario.
     * @path          /users/{userId}
     * @allow         (create) Un usuario autenticado puede crear su propio documento de perfil.
     * @allow         (get, update, delete) El propietario del perfil puede leerlo, actualizarlo o eliminarlo.
     * @deny          (list) Está estrictamente prohibido listar todos los perfiles de usuario por privacidad.
     * @deny          (get) Un usuario autenticado que intenta leer el perfil de otro usuario.
     * @principle     Restringe el acceso al árbol de datos de un usuario y aplica la autocreación.
     */
    match /users/{userId} {
      // LECTURA: Solo el propietario del documento puede leer su propio perfil.
      allow get: if isOwner(userId);
      // LECTURA: Se prohíbe explícitamente listar a todos los usuarios para proteger la privacidad del usuario.
      allow list: if false;

      // ESCRITURA: Un usuario puede crear su propio documento de perfil.
      // La validación asegura que el `uid` interno del documento coincida con el `userId` de la ruta.
      allow create: if isOwner(userId) && request.resource.data.uid == userId;
      // ESCRITURA: El propietario puede actualizar su perfil.
      // La validación asegura que el campo `uid` no se pueda cambiar después de la creación.
      allow update: if isExistingOwner(userId) && request.resource.data.uid == resource.data.uid;
      // ESCRITURA: El propietario puede eliminar su perfil.
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description   Asegura la colección de CVs de un usuario.
     * @path          /users/{userId}/cvs/{cvId}
     * @allow         (create) Un usuario autenticado puede crear un nuevo CV bajo su propio perfil.
     * @allow         (get, list, update, delete) El propietario puede leer, listar, actualizar y eliminar sus propios CVs.
     * @deny          (get) Un usuario autenticado que intenta acceder a un CV propiedad de otro usuario.
     * @principle     Aplica la propiedad del documento para todas las operaciones dentro de una subcolección específica del usuario.
     */
    match /users/{userId}/cvs/{cvId} {
      // LECTURA: El propietario puede leer y listar todos sus propios CVs.
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      // ESCRITURA: El propietario puede crear un nuevo CV.
      // La validación asegura que el nuevo documento de CV esté correctamente vinculado al propietario.
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      // ESCRITURA: El propietario puede actualizar un CV existente.
      // La validación asegura que el enlace de propiedad (`userId`) no se pueda cambiar.
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      // ESCRITURA: El propietario puede eliminar su propio CV.
      allow delete: if isExistingOwner(userId);
    }
  }
}
